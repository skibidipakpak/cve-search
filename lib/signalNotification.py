from lib.DatabaseLayer import getSubscriptions, getInfo

import subprocess

def _makeMessage(entity, product, cveid):
    if entity == 'All':
        return "New critical CVE to be treated: " + cveid
    return "New CVE impacting entity " + entity + "and product " + product + ": " + cveid

def sendNotification(entity, product, cveid):
    subscriptions = getSubscriptions()
    if subscriptions is None:
        return
    registeredPhone = getInfo('subscriptions')['registeredPhone']
    message = _makeMessage(entity, product, cveid)
    for subscription in subscriptions:
        subprocess.run(["signal-cli", "-u", registeredPhone, "send", "-m", message, "-g", subscription['groupid']])