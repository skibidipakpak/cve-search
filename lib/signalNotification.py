from lib.DatabaseLayer import getInfo
import os
import subprocess
import datetime

runPath = os.path.dirname(os.path.realpath(__file__))

def _makeMessage(cve, new):
    if new:
        msg = 'New '
    else:
        msg = 'Update regarding '

    if cve['entity'] == 'All':
        if cve['product'] != '':
            msg += "critical CVE, product: " + cve['product'] + ". https://cvepremium.circl.lu/cve/" + cve['id'] + " cvss3: " + str(cve['cvss3'])
        else:
            msg += "critical CVE. https://cvepremium.circl.lu/cve/" + cve['id'] + " cvss3: " + str(cve['cvss3'])
    else:
        msg += "CVE impacting " + cve['entity'] + ", product: " + cve['product'] + ". "\
            + "https://cvepremium.circl.lu/cve/" + cve['id'] + " cvss3: " + str(cve['cvss3'])
    return msg

def sendNotification(cve, new=False, signal_groups=[]):
    registeredPhone = getInfo('subscriptions')['registeredPhone']
    message = _makeMessage(cve, new)
    with open(runPath + '/../log/notification_logs', 'a+') as f:
        f.write(str(datetime.datetime.now())+ ' ' + message + '\n')
    if signal_groups is None:
        return
    for group in signal_groups:
        subprocess.run(["signal-cli", "-u", registeredPhone, "send", "-m", message, "-g", group])