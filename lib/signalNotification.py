from lib.DatabaseLayer import getSubscriptions, getInfo

import subprocess

def _makeMessage(cve):
    if cve['entity'] == 'All':
        return "Critical CVE: https://cvepremium.circl.lu/cve/" + cve['id'] + " cvss3: " + str(cve['cvss3'])
    return "CVE impacting entity " + cve['entity'] + " and product " + cve['product'] + ". "\
            + "https://cvepremium.circl.lu/cve/" + cve['id'] + " cvss3: " + str(cve['cvss3'])

def sendNotification(cve):
    subscriptions = getSubscriptions()
    if subscriptions is None:
        return
    registeredPhone = getInfo('subscriptions')['registeredPhone']
    message = _makeMessage(cve)
    for subscription in subscriptions:
        subprocess.run(["signal-cli", "-u", registeredPhone, "send", "-m", message, "-g", subscription['groupid']])