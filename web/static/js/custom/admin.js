function updateDB(){
  showMessage("Database update started", "info")

  $.ajax({
        type: "get",
        url: '/admin/updatedb',
        success: function(response) {
            parseStatus(response['status'])
        },
        error: function(xhr, ajaxOptions, thrownError) {
            showMessage(thrownError, "error")
            parseStatus("auth_again")
        }
    });

}

function whitelistImport(){ listURLBuilder("/admin/whitelist/import", 'wl');}
function blacklistImport(){ listURLBuilder("/admin/blacklist/import", 'bl');}
function whitelistExport(){ window.location = '/admin/whitelist/export';}
function blacklistExport(){ window.location = '/admin/blacklist/export';}

function dropWhitelist(){

    const swalWithBootstrapButtons = Swal.mixin({
      customClass: {
        confirmButton: 'btn btn-success btn-sm',
        cancelButton: 'btn btn-danger btn-sm margin-left'
      },
      buttonsStyling: false
    })

    swalWithBootstrapButtons.fire({
      title: 'You are about to drop the Whitelist. Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, drop it!',
    }).then((result) => {
      if (result["value"]) {
        $.ajax({
            type: "get",
            url: '/admin/whitelist/drop',
            success: function(response) {
                parseStatus(response['status'])
                $("#wl_rules").text("Whitelist: 0 rules");
            },
            error: function(xhr, ajaxOptions, thrownError) {
                showMessage(thrownError, "error")
            }
        });
      }
    })
}

function dropBlacklist(){

    const swalWithBootstrapButtons = Swal.mixin({
      customClass: {
        confirmButton: 'btn btn-success btn-sm',
        cancelButton: 'btn btn-danger btn-sm margin-left'
      },
      buttonsStyling: false
    })

    swalWithBootstrapButtons.fire({
      title: 'You are about to drop the Whitelist. Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonText: 'Yes, drop it!',
    }).then((result) => {
      if (result["value"]) {
        $.ajax({
            type: "get",
            url: '/admin/blacklist/drop',
            success: function(response) {
                parseStatus(response['status'])
                $("#bl_rules").text("Blacklist: 0 rules");
            },
            error: function(xhr, ajaxOptions, thrownError) {
                showMessage(thrownError, "error")
            }
        });
      }
    })
}

function listURLBuilder(url, list){
  var file = list+"_Import";
  var force = "";
  if ((document.getElementById(file).files).length == 1){
    if (document.getElementById(list+"_ForceImport").checked == true){
      force = "f";
    }else{
      force = "df";
    }
    postURL(url, force, file)
  }else{
    alert('Please select a file');
  }
}
function postURL(url, force, file) {
  var form = document.createElement("FORM");
  form.enctype="multipart/form-data";
  form.method = "POST";
  form.style.display = "none";
  document.body.appendChild(form);
  form.action = url
  inputForce = document.createElement("INPUT");
  inputForce.type = "hidden";
  inputForce.name = "force"
  inputForce.value = force
  form.appendChild(inputForce);
  inputFile = document.getElementById(file);
  form.appendChild(inputFile);
  form.submit();
}
function changePass() {
  var pass1 = document.getElementById("new_pass").value;
  var pass2 = document.getElementById("repeat_pass").value;
  var ok = true;
  if (pass1 != pass2) {
    document.getElementById("new_pass").style.borderColor = "#E34234";
    document.getElementById("repeat_pass").style.borderColor = "#E34234";
  } else {

    data = {'new_pass':pass1, 'current_pass':document.getElementById("current_pass").value}
    $.ajax({
        type: "post",
        url: '/admin/change_pass',
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(response) {
            parseStatus(response['status'])
        },
        error: function(xhr, ajaxOptions, thrownError) {
            showMessage(thrownError, "error")
        }
    });

  }
}

function verify() {
  var phone = document.getElementById("verify").value;
  var found = phone.match("\\+[0-9]+")
  if (found === null) {
    showMessage("Incorrect phone number format", "error")
  } else {

    data = {'phone':phone}
    $.ajax({
        type: "post",
        url: '/admin/verify',
        data: JSON.stringify(data),
        contentType: "application/json; charset=utf-8",
        dataType: "json",
        success: function(response) {
            if (response['errormsg']){
              document.getElementById('signal_error').innerHTML = "<p style=\"color:red;\">" + response['errormsg'] + "</p>"
              if (response['errormsg'].includes("Captcha required")){
                document.getElementById('captcha_row').innerHTML = '<td class="input_padding_right">Captcha</td>'
                + '<td><input type="text" class="form-control" name="captcha" id="captcha"></td>'
                + '<td><button class="btn btn-primary btn-sm" onclick="verifyCaptcha()">Send</button></td>'
              }
            } else {
              parseStatus(response['status'])
              if (response['status'] == "code_needed"){
                document.getElementById('verificationCode_row').innerHTML = "<td class=\"input_padding_right\">Verification code</td>"
                + "<td><input type=\"text\" class=\"form-control\" name=\"verificationCode\" id=\"verificationCode\"></td>"
                + "<td><button class=\"btn btn-primary btn-sm\" onclick=\"verifyCode()\">Verify</button></td>"
              }
            }
        },
        error: function(xhr, ajaxOptions, thrownError) {
            showMessage(thrownError, "error")
        }
    });

  }
}

function verifyCaptcha() {
  var captcha = document.getElementById("captcha").value;
  var phone = document.getElementById("verify").value;
  data = {'captcha':captcha, 'phone':phone}
  $.ajax({
      type: "post",
      url: '/admin/verifyCaptcha',
      data: JSON.stringify(data),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function(response) {
          parseStatus(response['status'])
          if (response['status'] == 'code_needed'){
            document.getElementById('verificationCode_row').innerHTML = "<td class=\"input_padding_right\">Verification code</td>"
                + "<td><input type=\"text\" class=\"form-control\" name=\"verificationCode\" id=\"verificationCode\"></td>"
                + "<td><button class=\"btn btn-primary btn-sm\" onclick=\"verifyCode()\">Verify</button></td>"
          }
      },
      error: function(xhr, ajaxOptions, thrownError) {
          showMessage(thrownError, "error")
      }
  });
}

function verifyCode() {
  var code = document.getElementById("verificationCode").value;
  var phone = document.getElementById("verify").value;
  data = {'code':code, 'phone':phone}
  $.ajax({
      type: "post",
      url: '/admin/verifyCode',
      data: JSON.stringify(data),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function(response) {
          parseStatus(response['status'])
          setInterval('location.reload()', 2000);
      },
      error: function(xhr, ajaxOptions, thrownError) {
          showMessage(thrownError, "error")
      }
  });
}

function addGroup(){
  var groupID = document.getElementById("group_id").value;
  data = {'groupID':groupID}
  $.ajax({
      type: "post",
      url: '/admin/addGroup',
      data: JSON.stringify(data),
      contentType: "application/json; charset=utf-8",
      dataType: "json",
      success: function(response) {
          parseStatus(response['status'])
      },
      error: function(xhr, ajaxOptions, thrownError) {
          showMessage(thrownError, "error")
      }
  });
}


