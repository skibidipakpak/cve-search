{% extends 'layouts/master-page.html' %}
{% block title %}Watchlist{% endblock %}
{% block head %}
<!-- css -->
<link href="/static/css/custom/filter.css" rel="stylesheet" />
<link href="/static/css/dataTables.bootstrap4.min.css" rel="stylesheet" />

<!-- javascript -->
<script type="text/javascript" src="/static/js/custom/filter.js"></script>
<script type="text/javascript" src="/static/js/custom/watchlist.js"></script>
<script type="text/javascript" src="/static/js/jquery.dataTables.min.js"></script>
<script type="text/javascript" src="/static/js/dataTables.bootstrap4.min.js"></script>
<script type="text/javascript">
    $(document).ready(function(){
      setFilters();
      {% if errors %}
        setStatus("An error occured while parsing the filters. Please verify the input fields, like the dates", "danger");
      {% endif %}
    })
    function setFilters(){
      {% if filters is defined %}
        {% for key, val in filters.items() %}
          if($("#{{key}}").is(":checkbox")){
            if("{{val}}" === "on"){$("#{{key}}").prop('checked', true);}
          }else{
            $("#{{key}}").val("{{val}}");
          }
        {% endfor %}
        cvssSelectDisable()
        timeSelectDisable()
      {%endif%}
    }
  </script>
{% endblock %}
{% block content %}
<!-- breadcrumb -->
{% include 'subpages/breadcrumbs.html' %}
<!-- Filter options -->
{% include 'subpages/filters.html' %}


<button data-toggle="tooltip" class="btn btn-info btn-sm float-right" onclick="exportCSV()"><i class="fas fa-file-csv"></i> CSV export</button>


<!-- Search results -->
{% include 'subpages/watchlist_table.html' %}

<iframe id="csv-download" style="display:none;"></iframe>
{% endblock %}

{% block body_scripts %}

<script>
function getFormData(top){

    if (top !== "top") {
      $('#filter-toggle').click();
    }

    var form_elements = document.getElementById('filter').elements;

    value_dict = {};

    for (var i = 0; i < form_elements.length; i++) {
        if (form_elements[i].id != "filter_send" && form_elements[i].id != "filter_reset") {
          value_dict[form_elements[i].id] = form_elements[i].value
        }
    }

    $.ajax({
            url: "/set_filter",
            type: "post",
            data: JSON.stringify(value_dict),
            contentType: "application/json; charset=utf-8",
            dataType: "json",
            success: function(response) {
               //
            },
            error: function(xhr) {
               //Do Something to handle error
            },
            complete: function(data) {
              var table = $('#CVEs').DataTable();
              table.ajax.reload();
              $('#filter_off').addClass('d-none');
              $('#filter_on').removeClass('d-none');
            }
        });
}

function reset_filters() {
  $.ajax({
            url: "/reset_filter",
            type: "get",
            success: function(response) {
               //
            },
            error: function(xhr) {
               //Do Something to handle error
            },
            complete: function(data) {
              var table = $('#CVEs').DataTable();
              table.ajax.reload();
              $('#filter_off').removeClass('d-none');
              $('#filter_on').addClass('d-none');
            }
        });
}
</script>
<script>
function ConvertDateTime(datetimestring) {
  if (datetimestring)
  {
    var date = new Date(datetimestring);
    return date.toISOString().substring(0, 10) + ' - ' + date.toTimeString().substring(0, 5);
  }
  return '';
}

  $(document).ready(function() {
       $('#CVEs').DataTable({
           "processing": true,
           "fixedColumns": true,
           "serverSide": true,
           "lengthMenu": [[10, 25, 50, 1000000], [10, 25, 50, "All"]],
           "ajax": {
               "url": "/fetch_cve_data",
               "data": function ( d ) {
                   d.retrieve = "watchlist";
               },
               "type": "POST"
            },
           "columnDefs": [
             {bSortable: false, targets: [3, 4]},
           ],
           "order": [[ 5, "desc" ]],
           "orderMulti": false,
           "columns": [
               { "data": "id" ,
                   render : function(data, type, row) {
                      return '<a href="/watchlist/'+ row['id'] + '?entity='+row['entity']+'&product='+row['product']+ '"' + 'width="20" height="20" title="Active">'+ row['id'] +'</a><br><br>'
                            +'<button data-toggle="tooltip" data-placement="top" title="Delete CVE from watchlist" style="margin-left:45px;" type="button" class="btn btn-secondary btn-sm" onclick="delete_from_watchlist(\'' + row['id']+'\',\'' + row['entity']+'\',\'' + row['product'] + '\')"><i class="fas fa-trash-alt"></i></button>'
                   }
               },
               { "data": "cvss",
                 "defaultContent": ''},

               { "data": "cvss3",
                 "defaultContent": ''},

               { "data": "summary" ,
                   render : function(data, type, row) {
                      return escapeHtml(row['summary'])
                   },
                 "defaultContent": '',
               },
               { "data": "comment" ,
                   render : function(data, type, row) {
                     return escapeHtml(row['comment']).split("\n").join("<br/>");
                   },
                 "defaultContent": '',
               },
               { "data": "last-modified" ,
                   render : function(data, type, row) {
                      var dtg = ConvertDateTime(row['last-modified'])
                      return dtg
                    }
               },
               { "data": "Published",
                   render : function(data, type, row) {
                      var dtg = ConvertDateTime(row['Published'])
                      return dtg
                    }
               },
               { "data": "entity",
                   render : function(data, type, row) {
                       return escapeHtml(row['entity'])
                   },
                   "defaultContent": ''
               },
               { "data": "product",
                   render : function(data, type, row) {
                      return escapeHtml(row['product'])
                   },
                   "defaultContent": ''
               },
               { "data": "assignee",
                   render : function(data, type, row) {
                      return escapeHtml(row['assignee'])
                   },
                   "defaultContent": ''
               },
               { "data": "treated",
                  render : function(data, type, row) {
                      if (row['treated'] != true){
                        return '<div id='+row['id']+row['entity']+row['product']+'_treated'+'><button data-toggle="tooltip" data-placement="top" title="Mark as treated" class="btn btn-danger btn-sm" onclick="switchStatus(\'' + row['id']+'\',\'' + row['entity']+'\',\'' + row['product'] +  '\', false)"><i class="fas fa-times-circle"></i></button></div>'
                      }
                      else{
                        return '<div id='+row['id']+row['entity']+row['product']+'_treated'+'><button data-toggle="tooltip" data-placement="top" title="Mark as not treated" class="btn btn-success btn-sm" onclick="switchStatus(\'' + row['id']+'\',\'' + row['entity']+'\',\'' + row['product'] + '\', true)"><i class="fas fa-check-circle"></i></button></div>'
                      }
                  },
               "defaultContent": ''
               },
           ],
           "iDisplayLength": {{pageLength}},
           "language": { "processing": "<img src='{{ url_for('static', filename='img/ajaxload.gif') }}'> Loading...",
               "zeroRecords": "No records to display", searchPlaceholder: "Regex search...", search: ""},
           "search": {
               "regex": true
           },
           createdRow: function (row, data, index){
             $(row).addClass(data['id'] + '_' + data['entity'] + '_' + data['product'])
           }
       });
       $('#CVEs').removeClass('d-none');

       $.ajax({
            url: "/get_filter",
            type: "get",
            success: function(response) {
               //
            },
            error: function(xhr) {
               //
            },
            complete: function(data) {

                var isTrueSet = (data.responseJSON === true);

                if (isTrueSet) {
                    $('#filter_off').removeClass('d-none');
                    $('#filter_on').addClass('d-none');
                }
                else {
                    $('#filter_off').addClass('d-none');
                    $('#filter_on').removeClass('d-none');
                }

            }
        });

  } );
</script>
{% endblock %}